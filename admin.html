<!DOCTYPE html>
<html lang="tet">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - CandleCarla</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
    body { min-height: 100vh; background: url("uploads/img_6997c894d71536.96769143.jpg") center/cover no-repeat fixed; color: #fff; }
    body::before { content: ''; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); z-index: -1; }
    .topbar { background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(212, 175, 55, 0.3); position: sticky; top: 0; z-index: 100; }
    .logo { font-size: 22px; font-weight: bold; background: linear-gradient(to right, #FFD700, #FDB931); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
    .btn-gold { background: linear-gradient(45deg, #D4AF37, #FFD700); color: #000; border: none; padding: 8px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
    .btn-gold:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255,215,0,0.4); }
    .btn-danger { background: rgba(231, 76, 60, 0.8); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .btn-danger:hover { transform: scale(1.05); background: #e74c3c; }
    .container { padding: 20px; max-width: 1200px; margin: auto; }
    .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 20px; margin-bottom: 30px; }
    input { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.3); border: 1px solid rgba(212,175,55,0.3); border-radius: 8px; color: white; }
    input:focus { outline: none; border-color: #FFD700; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .product-card { background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 12px; overflow: hidden; transition: 0.3s; }
    .product-card:hover { transform: translateY(-5px); border-color: #FFD700; }
    .product-card img { width: 100%; height: 200px; object-fit: cover; }
    .product-card h3 { color: #FFD700; padding: 10px; margin: 0; }
    .product-card p { padding: 0 10px 10px; color: #ccc; font-size: 14px; }
    .slider-container { display: flex; gap: 15px; overflow-x: auto; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 12px; margin-bottom: 20px; }
    .slider-item { min-width: 200px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; border: 1px solid rgba(212,175,55,0.3); }
    .slider-item img { width: 100%; height: 120px; object-fit: cover; }
    .slider-item div { padding: 8px; color: #FFD700; font-weight: bold; text-align: center; }
    #preview { position:fixed; inset:0; background:#000c; display:none; justify-content:center; align-items:center; z-index:1000; cursor:pointer; }
    #preview img { max-width:90%; max-height:90%; border:2px solid #FFD700; }
  </style>
</head>
<body>
<?php
session_start();
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
  echo "<script>window.location.href='index.html';</script>";
  exit;
}
?>
<div class="topbar">
  <div class="logo">üëë Admin Panel</div>
  <div>
    <span style="margin-right:15px; color:#FFD700;">Ol√°, <?= htmlspecialchars($_SESSION['username']) ?></span>
    <button class="btn-gold" onclick="logout()">Sai</button>
  </div>
</div>
<div class="container">  <div class="card">
    <h3 style="color:#FFD700; margin-bottom:15px;">‚ûï Aumenta Produk</h3>
    <input id="nama" placeholder="Naran Produk">
    <input id="warna" placeholder="Kor">
    <input id="ukuran" placeholder="Size">
    <input id="harga" placeholder="Folin ($)" type="number">
    <input type="file" id="gambarInput" multiple accept="image/*" style="border:none; padding:10px 0;">
    <div id="previewContainer" style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;"></div>
    <button class="btn-gold" onclick="tambahProduk()" style="width:100%; margin-top:10px;">üíæ Save Produk</button>
  </div>
  <h3 style="color:#FFD700; margin:20px 0 10px;">üé† Slider Promo Admin</h3>
  <div id="adminSlider" class="slider-container"></div>
  <h3 style="color:#FFD700; margin:20px 0 10px;">üì¶ Lista Produk</h3>
  <div id="adminList" class="grid"></div>
</div>
<div id="preview" onclick="this.style.display='none'"><img id="bigImg"></div>
<script>
const API_BASE = 'api';
let selectedFiles = [];

document.getElementById('gambarInput').addEventListener('change', function(e) {
  previewContainer.innerHTML = '';
  selectedFiles = Array.from(e.target.files);
  selectedFiles.forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      const div = document.createElement('div');
      div.style.position = 'relative';
      div.innerHTML = `<img src="${ev.target.result}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #FFD700;">`;
      previewContainer.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
});

async function api(endpoint, method = 'GET', body = null, useFormData = false) {
  const config = { method, headers: {} };
  if (useFormData) { config.body = body; }
  else { config.headers['Content-Type'] = 'application/json'; config.body = body ? JSON.stringify(body) : null; }
  const res = await fetch(`${API_BASE}/${endpoint}`, config);
  return res.json();
}

async function tambahProduk() {
  const nama = document.getElementById('nama').value.trim();
  const warna = document.getElementById('warna').value.trim();
  const ukuran = document.getElementById('ukuran').value.trim();
  const harga = document.getElementById('harga').value.trim() || '0';
    if (!nama) {
    alert('‚ùå Naran produk tenki isi!');
    return;
  }
  
  if (selectedFiles.length === 0) {
    alert('‚ùå Upload foto minimal 1!');
    return;
  }

  const formData = new FormData();
  formData.append('nama', nama);
  formData.append('warna', warna);
  formData.append('ukuran', ukuran);
  formData.append('harga', harga);
  selectedFiles.forEach(file => formData.append('images[]', file));

  try {
    const res = await fetch('api/products.php', {
      method: 'POST',
      body: formData
    });
    
    const result = await res.json();
    
    if (result.success) {
      document.getElementById('nama').value = '';
      document.getElementById('warna').value = '';
      document.getElementById('ukuran').value = '';
      document.getElementById('harga').value = '';
      document.getElementById('gambarInput').value = '';
      previewContainer.innerHTML = '';
      selectedFiles = [];
      
      await renderAdmin();
      await renderAdminSlider();
      
      alert('‚úÖ Produk hatama ho susesu!');
    } else {
      alert('‚ùå ' + (result.message || 'Falha hatama produk'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Error: ' + error.message);
  }
}

async function hapusProduk(id) {
  if (!confirm('Ita hakarak hapus produk nee?')) return;
    try {
    const res = await fetch('api/products.php', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: id })
    });
    
    const result = await res.json();
    
    if (result.success) {
      alert('‚úÖ Produk hapus tona');
      await renderAdmin();
      await renderAdminSlider();
    } else {
      alert('‚ùå Hapus la diak: ' + (result.message || 'Error'));
    }
  } catch (error) {
    console.error('Error:', error);
    alert('‚ùå Error: ' + error.message);
  }
}

async function renderAdmin() {
  try {
    const products = await api('products.php');
    const container = document.getElementById('adminList');
    
    if (!products || products.length === 0) {
      container.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#999">Seiduk iha produk</p>';
      return;
    }
    
    container.innerHTML = products.map(p => {
      const firstImg = Array.isArray(p.images) ? p.images[0] : '';
      const harga = p.harga || 0;
      
      return `<div class="product-card">
        <img src="${firstImg}" onclick="previewImg('${firstImg}')" onerror="this.src='image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22><text y=%22.9em%22 font-size=%2280%22>üïØÔ∏è</text></svg>'">
        <h3>${p.nama || 'Sem Naran'}</h3>
        <p>${p.warna || '-'} ‚Ä¢ ${p.ukuran || '-'}</p>
        <p style="color: #FFD700; font-weight: bold;">$ ${parseInt(harga).toLocaleString('en-US')}</p>
        <div style="padding:10px;">
          <button class="btn-danger" style="width:100%" onclick="hapusProduk(${p.id})">üóëÔ∏è Hapus</button>
        </div>
      </div>`;
    }).join('');
  } catch (error) {
    console.error('Error render:', error);
    document.getElementById('adminList').innerHTML = '<p style="color:red;text-align:center;">Error load produk</p>';
  }}

async function renderAdminSlider() {
  try {
    const products = await api('products.php');
    const slider = document.getElementById('adminSlider');
    
    if (!products || products.length === 0) {
      slider.innerHTML = '<p style="color:#999; margin:auto">Seiduk iha produk</p>';
      return;
    }
    
    const sliderItems = products.slice(0, 5).map(p => {
      const img = Array.isArray(p.images) ? p.images[0] : '';
      return `<div class="slider-item">
        <img src="${img}" onclick="event.stopPropagation(); previewImg('${img}')">
        <div>${p.nama || 'Sem Naran'}</div>
      </div>`;
    }).join('');
    
    slider.innerHTML = sliderItems;
  } catch (error) {
    console.error('Error slider:', error);
  }
}

function previewImg(src) {
  document.getElementById('bigImg').src = src;
  document.getElementById('preview').style.display = 'flex';
}

async function logout() {
  if (!confirm('Ita hakarak sai?')) return;
  try {
    await fetch('api/logout.php');
    localStorage.removeItem('user');
    window.location.href = 'index.html';
  } catch (error) {
    localStorage.removeItem('user');
    window.location.href = 'index.html';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  await renderAdmin();
  await renderAdminSlider();
});
</script>
</body>
</html>